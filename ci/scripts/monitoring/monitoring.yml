# ci/scripts/monitoring/monitoring.yml

.monitoring_template: # Neuer, eindeutiger Template-Name
  before_script:
    # --- before_script bleibt wie in der vorherigen funktionierenden Version ---
    - |
      set -e
      echo "--- Monitoring Job: Setting up SSH and Environment ---"
      # ... (Rest des before_script, das die MASTER_IP findet und ~/.ssh/config erstellt) ...
      # Die ~/.ssh/config ist immer noch nützlich für User und IdentityFile!
      echo "-----------------------------------------------------"

  script:
    # Verwende explizite Optionen bei ssh und scp
    - echo "Creating remote directories for monitoring..."
    - ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@$MASTER_IP "mkdir -p ~/$MONITORING_DIR/prometheus ~/$MONITORING_DIR/grafana"

    # Transfer monitoring YAML files using explicit options
    - echo "Transferring monitoring manifests..."
    - scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $KUBERNETES_DIR/monitoring/monitoring-namespace.yaml ubuntu@$MASTER_IP:~/$MONITORING_DIR/
    - scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $KUBERNETES_DIR/monitoring/prometheus/*.yaml ubuntu@$MASTER_IP:~/$MONITORING_DIR/prometheus/
    - scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $KUBERNETES_DIR/monitoring/grafana/*.yaml ubuntu@$MASTER_IP:~/$MONITORING_DIR/grafana/

    # Apply Kubernetes manifests via SSH using explicit options
    - echo "Applying monitoring manifests..."
    - |
      ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@$MASTER_IP "bash -l -c '
        set -e # Fail fast within the remote script
        echo \"--- Applying Kubernetes Monitoring Manifests --- \"

        echo \"Applying Namespace...\"
        sudo kubectl apply -f ~/$MONITORING_DIR/monitoring-namespace.yaml

        echo \"Deleting existing Prometheus ConfigMap to ensure clean apply...\"
        sudo kubectl delete configmap prometheus-config -n monitoring --ignore-not-found=true
        echo \"Deleting existing Grafana Datasource ConfigMap to ensure clean apply...\"
        sudo kubectl delete configmap grafana-datasources -n monitoring --ignore-not-found=true
        echo \"Deleting existing Grafana Secret...\"
        sudo kubectl delete secret grafana-admin-credentials -n monitoring --ignore-not-found=true

        echo \"Applying Prometheus components...\"
        sudo kubectl apply -f ~/$MONITORING_DIR/prometheus/

        echo \"Applying Grafana components...\"
        sudo kubectl apply -f ~/$MONITORING_DIR/grafana/

        echo \"Waiting for Prometheus deployment to complete (timeout 180s)...\"
        if ! sudo kubectl rollout status deployment/prometheus-deployment -n monitoring --timeout=180s; then
            echo \"Prometheus deployment failed to complete within timeout.\"
            echo \"Checking pod status:\"
            sudo kubectl get pods -n monitoring -l app=prometheus -o wide
            echo \"Checking deployment events:\"
            sudo kubectl describe deployment prometheus-deployment -n monitoring
            # exit 1
        else
            echo \"Prometheus deployment successful.\"
        fi

        echo \"Waiting for Grafana deployment to complete (timeout 180s)...\"
        if ! sudo kubectl rollout status deployment/grafana-deployment -n monitoring --timeout=180s; then
            echo \"Grafana deployment failed to complete within timeout.\"
            echo \"Checking pod status:\"
            sudo kubectl get pods -n monitoring -l app=grafana -o wide
            echo \"Checking deployment events:\"
            sudo kubectl describe deployment grafana-deployment -n monitoring
            # exit 1
        else
            echo \"Grafana deployment successful.\"
        fi

        echo \"---------------------------------------------------\"
        echo \"Monitoring stack deployment initiated. Final status:\"
        sudo kubectl get all -n monitoring
        echo \"---------------------------------------------------\"
      '"